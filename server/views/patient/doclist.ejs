<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/headnew.ejs') %>
</head>
<body class="">
  <div class="wrapper ">
    <%- include('../partials/sidebar.ejs') %>
    <div class="main-panel">
      <%- include('../partials/topbar.ejs') %>
      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header card-header-warning">
                  <h4 class="card-title ">Doctor List</h4>
                  <p class="card-category"> List of Registered Doctors as of  <script>
                    document.write(new Date())
                  </script></p></p>
                </div>
                <div class="card-body table-responsive">
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead class="text-primary">
                        <th>
                          ID
                        </th>
                        <th>
                          Name
                        </th>
                        <th>
                          Email
                        </th>
                        <th>
                          Specialization
                        </th>
                        <th>
                          Institute
                        </th>
                        <th>
                          Grant
                        </th>
                        <th>
                            Revoke
                        </th>
                        <th>
                            Prescription
                        </th>
                      </thead>
                      <tbody>
                        <% for (let doctor=0; doctor<doctors.length; doctor++){ %>
                        <tr>
                          <td>
                            <%= doctor + 1%>
                          </td>
                            <td>
                                <%= doctors[doctor].name %>
                            </td>
                            <td>
                                <%= doctors[doctor].email %>
                            </td>
                            <td>
                                <%= doctors[doctor].specialization %>
                            </td>
                            <td>
                                <%= doctors[doctor].institute %>
                            </td>
                            <td >
                                <form action="/user/access" method="post" id="grantform">
                                  <input type="hidden" value="<%= doctors[doctor].username %>" name="value" />
                                  <button  type="submit"
                                  data-toggle="modal" data-target="#grant-modal-<%= doctors[doctor].username %>" 
                                  rel="tooltip" title="Grant Access" class="btn btn-danger btn-link btn-sm">
                                    <i class="material-icons">check</i>
                                  </button> 
                                </form>  
                                  <!-- Modal -->
                                <div class="modal fade" id="grant-modal-<%= doctors[doctor].username %>" tabindex="-1" role="dialog" aria-labelledby="grant-title-<%= doctors[doctor].username %>" aria-hidden="true">
                                  <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <h5 class="modal-title text-primary" id="grant-title-<%= doctors[doctor].username %>">DOCUMENT LIST<br>
                                        <p class="card-category "> <i class="material-icons">access_time</i> updated  <script>
                                          document.write(new Date())
                                        </script> ago </p></h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <span aria-hidden="true">&times;</span>
                                        </button>
                                      </div>
                                      <form method="post" action="/user/check">
                                      <div class="modal-body" id="grant-div-<%= doctors[doctor].username %>" >
 
                                      </div>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        <button type="submit" value="submit" class="btn btn-primary">Save changes</button>
                                      </div>
                                    </form>
                                    </div>
                                  </div>
                                </div>
                            </td>
                            <td>
                                <form action="/user/revoke" method="post" id="revokeform">
                                  <input type="hidden" value="<%= doctors[doctor].username %>" name="value" />
                                  
                                    <button  type="submit" 
                                    data-toggle="modal" data-target="#revoke-modal-<%= doctors[doctor].username %>" 
                                    rel="tooltip" title="Revoke Access" class="btn btn-danger btn-link btn-sm">
                                      <i class="material-icons">close</i>
                                    </button> 
                                </form>  
                                <!-- Modal -->
                                <div class="modal fade" id="revoke-modal-<%= doctors[doctor].username %>" tabindex="-1" role="dialog" aria-labelledby="revoke-title-<%= doctors[doctor].username %>" aria-hidden="true">
                                  <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <h5 class="modal-title text-primary" id="revoke-title-<%= doctors[doctor].username %>">DOCUMENT LIST<br>
                                          <p class="card-category "> <i class="material-icons">access_time</i> updated  <script>
                                            document.write(new Date())
                                          </script> ago </p></h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <span aria-hidden="true">&times;</span>
                                        </button>
                                      </div>
                                      <form method="post" action="/user/uncheck">
                                      <div class="modal-body" id="revoke-div-<%= doctors[doctor].username %>">

                                      </div>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        <button type="submit" value="submit" class="btn btn-primary">Save changes</button>
                                      </div>
                                    </form>
                                    </div>
                                  </div>
                                </div>
                            </td>
                            <td>
                                <form action="/user/prescription" method="post" id="prescribeform">
                                  <input type="hidden" value="<%= doctors[doctor].username %>" name="value" />
                              
                                    <button  type="submit" 
                                    data-toggle="modal" data-target="#prescribe-modal-<%= doctors[doctor].username %>" 
                                    rel="tooltip" title="Prescription" class="btn btn-danger btn-link btn-sm">
                                      <i class="material-icons">content_paste</i>
                                    </button> 
                                </form>  
                                <!-- Modal -->
                                <div class="modal fade" id="prescribe-modal-<%= doctors[doctor].username %>" tabindex="-1" role="dialog" aria-labelledby="prescribe-title-<%= doctors[doctor].username %>" aria-hidden="true">
                                  <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <h5 class="modal-title text-primary" id="prescribe-title-<%= doctors[doctor].username %>">PRESCRIPTIONS<br>
                                          <p class="card-category "> <i class="material-icons">access_time</i> updated  <script>
                                            document.write(new Date())
                                          </script> ago </p></h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <span aria-hidden="true">&times;</span>
                                        </button>
                                      </div>
                                      <div class="modal-body" id="prescribe-div-<%= doctors[doctor].username %>" >

                                      </div>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                            </td>
                        </tr>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <%- include('../partials/footer.ejs') %>
    </div>
  </div>
  <script>
    

    function makeModal(doctor,records, app){
      let inner = "";
      let table = "";
      const element = document.getElementById(app);
      const labelstart=`<div class=" table-responsive">
                                <table class="table table-hover">
                                  <thead class="text-primary">
                                    <th> Document ID </th>
                                    <th> Description </th>
                                    <th> File</th>
                                  </thead>
                                  <tbody>`
      const labelend = `</tbody>
                                </table>
                              </div>`
      for (let d=0; d<records.records.length; d++){ 
        const mainDiv = ` <tr>
                            <td>${d+1}</td>
                            <td>${records.records[d].data.description}</td>
                            <td>
                              <div class="form-check ">
                                <label class="form-check-label">
                                  <input class="form-check-input " type="checkbox" name="${d}" value="${records.records[d].id}" />
                                    <span class="form-check-sign">
                                      <span class="check"></span>
                                    </span>
                                </label>
                              </div>
                            </td>
                          </tr>`
        inner +=  mainDiv
      }
        const input = `<input type="hidden" value="${doctor}" name="value" />`
        table = labelstart + inner + labelend
        table += input
        element.innerHTML = table 
        console.log(element)
    }

    function prescribeModal(doctor,records, app){
      let inner = "";
      let table = "";
      const element = document.getElementById(app);
      const labelstart=`<div class=" table-responsive">
                                <table class="table table-hover">
                                  <thead class="text-primary">
                                    <th> Prescription Number </th>
                                    <th> Prescription </th>
                                    <th> Description </th>
                                    <th> File</th>
                                  </thead>
                                  <tbody>`
      const labelend = `</tbody>
                                </table>
                              </div>`

      for (let d=0; d<records.records.length; d++){ 
        const mainDiv = ` <tr>
                            <td>${d+1}</td>
                            <td>${records.records[d].prescription}</td>
                            <td>${records.records[d].description}</td>
                            <td>
                                  <form method="post" action="/view">
                                        <input type="hidden" name="status" value="decrypted"> 
                                        <button  type="submit" rel="tooltip" title="File" class="btn btn-danger btn-link btn-sm" value="${records.records[d].file}" name="fileURL">
                                          <i class="material-icons">attachment</i>
                                        </button>
                                  </form>       
                            </td>
                          </tr>`
        inner +=  mainDiv
      }
        table = labelstart + inner + labelend
        element.innerHTML = table 
    }

document.getElementById("grantform").onsubmit = async (event) => {
  event.preventDefault();
  const doctor = new FormData(document.getElementById("grantform")).get("value");
  const modalId = `grant-modal-${doctor}`
  const divId = `grant-div-${doctor}`
  console.log("doctor", doctor)
  const response = await fetch('/user/access', {
    method: 'POST',
    headers: {
					'Content-Type': 'application/json'
				},
      body: JSON.stringify({ value: doctor})
  });
  const result = await response.json();
  makeModal(doctor, result, divId);
  document.getElementById(modalId).style.display = "block";
}

document.getElementById("revokeform").onsubmit = async(event) => {
  event.preventDefault();
  const doctor = new FormData(document.getElementById("revokeform")).get("value");
  const modalId = `revoke-modal-${doctor}`
  const divId = `revoke-div-${doctor}`
  const response = await fetch('/user/revoke', {
    method: 'POST',
    headers: {
					'Content-Type': 'application/json'
				},
      body: JSON.stringify({ value: doctor})
  });
  const result = await response.json();
  makeModal(doctor, result, divId);
  document.getElementById(modalId).style.display = "block"
}

document.getElementById("prescribeform").onsubmit = async(event) => {
  event.preventDefault();
  const doctor = new FormData(document.getElementById("prescribeform")).get("value");
  const modalId = `prescribe-modal-${doctor}`
  const divId = `prescribe-div-${doctor}`
  const response = await fetch('/user/prescription', {
    method: 'POST',
    headers: {
					'Content-Type': 'application/json'
				},
      body: JSON.stringify({ value: doctor})
  });
  const result = await response.json();
  makeModal(doctor, result, divId);
  document.getElementById(modalId).style.display = "block"
}
   </script> 
  <%- include('../partials/footerfiles.ejs') %>
</body>

</html>